<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½”ëƒ ê²Œì„ì¦ˆ í†µí•© ê´€ë¦¬ - ê²€ ê°•í™” ê²Œì„</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #4dabf7; --bg: #f8f9fa; --sidebar: #1a1d21; --success: #28a745; --danger: #dc3545; }
        body { display: flex; margin: 0; font-family: 'Pretendard', sans-serif; background: var(--bg); color: #333; }
        
        /* ì‚¬ì´ë“œë°” (ê¸°ì¡´ ë””ìì¸ ìœ ì§€) */
        nav { width: 260px; height: 100vh; background: var(--sidebar); color: white; padding: 25px; position: fixed; }
        nav h2 { color: var(--primary); cursor: pointer; }
        nav ul { list-style: none; padding: 0; margin-top: 30px; }
        nav ul li { padding: 15px; border-radius: 8px; cursor: pointer; color: #adb5bd; margin-bottom: 5px; }
        nav ul li.active { background: var(--primary); color: white; font-weight: bold; }

        /* ë©”ì¸ ì˜ì—­ */
        main { margin-left: 260px; padding: 40px; width: calc(100% - 260px); }
        .section-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .header-flex { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: #f1f3f5; padding: 12px; text-align: left; font-size: 13px; color: #666; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 14px; }
        
        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        input[type="text"], input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%; }
        .btn { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-save { background: var(--success); color: white; }
        .btn-add { background: #e67e22; color: white; }
        .btn-ban { background: var(--danger); color: white; padding: 5px 10px; font-size: 12px; }
        
        .img-preview { width: 40px; height: 40px; border-radius: 5px; object-fit: contain; background: #eee; }
        .tab-menu { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; background: #e9ecef; border-radius: 8px; cursor: pointer; border: none; }
        .tab-btn.active { background: var(--primary); color: white; }
    </style>
</head>
<body>
    <nav>
        <h2 onclick="location.href='index.html'">codetbase</h2>
        <ul>
            <li onclick="location.href='index.html'">ğŸ“Š í†µí•© ëŒ€ì‹œë³´ë“œ</li>
            <li class="active">ğŸ® ì½”ëƒ ê²Œì„ì¦ˆ ê´€ë¦¬</li>
            <li>ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</li>
        </ul>
    </nav>

    <main>
        <div class="header-flex">
            <h1>ğŸ® ì½”ëƒ ê²Œì„ì¦ˆ (ê²€ ê°•í™”) ê´€ë¦¬</h1>
            <button class="btn btn-save" onclick="saveAllData()"><i class="fas fa-save"></i> ëª¨ë“  ë³€ê²½ì‚¬í•­ ì €ì¥</button>
        </div>

        <div class="tab-menu">
            <button class="tab-btn active" onclick="switchTab('sword')">âš”ï¸ ê²€ ë°ì´í„°</button>
            <button class="tab-btn" onclick="switchTab('code')">ğŸ ë³´ìƒ ì½”ë“œ</button>
            <button class="tab-btn" onclick="switchTab('user')">ğŸ‘¥ ê²Œì„ ìœ ì €</button>
        </div>

        <div id="tab-sword" class="section-card">
            <div class="header-flex">
                <h3>ì•„ì´í…œ ê°•í™” íŠ¸ë¦¬ ì„¤ì •</h3>
                <button class="btn btn-add" onclick="addSwordRow()">+ ì‹ ê·œ ê²€ ì¶”ê°€</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th width="60">ë ˆë²¨</th><th width="150">ì´ë¦„</th><th>ì„¤ëª…</th><th width="100">ê°•í™”ë¹„</th><th width="100">ë§¤ê°ê°€</th><th width="80">í™•ë¥ </th><th width="120">ì´ë¯¸ì§€</th><th width="50">ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody id="sword-body"></tbody>
            </table>
        </div>

        <div id="tab-code" class="section-card" style="display:none;">
            <div class="header-flex">
                <h3>ë³´ìƒ/ì¿ í° ì½”ë“œ ë°œê¸‰</h3>
                <button class="btn btn-add" onclick="addCodeRow()">+ ìƒˆ ì½”ë“œ ìƒì„±</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ì½”ë“œëª…</th><th>ë³´ìƒ ê³¨ë“œ</th><th>ì „ì²´ ìˆ˜ëŸ‰</th><th>ì¸ë‹¹ ì œí•œ</th><th>ìƒíƒœ</th><th>ì‚­ì œ</th>
                    </tr>
                </thead>
                <tbody id="code-body"></tbody>
            </table>
        </div>

        <div id="tab-user" class="section-card" style="display:none;">
            <h3>ê²Œì„ ì‚¬ìš©ì ì‹¤ì‹œê°„ ê´€ë¦¬</h3>
            <div style="margin-bottom:15px;">
                <input type="text" id="userSearch" oninput="filterUsers()" placeholder="ë‹‰ë„¤ì„ìœ¼ë¡œ ê²€ìƒ‰...">
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ë‹‰ë„¤ì„</th><th>ê³¨ë“œ</th><th>ë¨¸ë‹ˆ</th><th>ë ˆë²¨</th><th>ìƒíƒœ</th><th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="user-body"></tbody>
            </table>
        </div>
    </main>

    <script>
        // ì—…ì†Œë“œ ê²Œì„ì¦ˆ Supabase ì„¤ì •
        const GAME_URL = "https://utfrjzcnefsbuadnkdud.supabase.co";
        const GAME_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc";
        const _gameClient = supabase.createClient(GAME_URL, GAME_KEY);

        let swordData = [], codeData = [], userData = [];

        async function loadGameData() {
            const { data: s } = await _gameClient.from('sword_data').select('*').order('level', { ascending: true });
            const { data: c } = await _gameClient.from('reward_codes').select('*');
            const { data: u } = await _gameClient.from('profiles').select('*').order('nickname', { ascending: true });
            
            swordData = s || []; codeData = c || []; userData = u || [];
            renderAll();
        }

        function renderAll() {
            // ê²€ ë Œë”ë§
            const sBody = document.getElementById('sword-body');
            sBody.innerHTML = swordData.map((s, i) => `
                <tr>
                    <td><input type="number" value="${s.level}" onchange="swordData[${i}].level=this.value"></td>
                    <td><input type="text" value="${s.name}" onchange="swordData[${i}].name=this.value"></td>
                    <td><input type="text" value="${s.description || ''}" onchange="swordData[${i}].description=this.value"></td>
                    <td><input type="number" value="${s.upgrade_cost}" onchange="swordData[${i}].upgrade_cost=this.value"></td>
                    <td><input type="number" value="${s.sell_price || 0}" onchange="swordData[${i}].sell_price=this.value"></td>
                    <td><input type="number" step="0.01" value="${s.success_rate}" onchange="swordData[${i}].success_rate=this.value"></td>
                    <td><img src="${s.image_url}" class="img-preview"></td>
                    <td><button class="btn-ban" onclick="swordData.splice(${i},1); renderAll()">X</button></td>
                </tr>
            `).join('');

            // ì½”ë“œ ë Œë”ë§
            const cBody = document.getElementById('code-body');
            cBody.innerHTML = codeData.map((c, i) => `
                <tr>
                    <td><input type="text" value="${c.code}" onchange="codeData[${i}].code=this.value"></td>
                    <td><input type="number" value="${c.reward_gold}" onchange="codeData[${i}].reward_gold=this.value"></td>
                    <td><input type="number" value="${c.max_uses}" onchange="codeData[${i}].max_uses=this.value"></td>
                    <td><input type="number" value="${c.per_user_limit}" onchange="codeData[${i}].per_user_limit=this.value"></td>
                    <td>${c.active ? 'âœ… í™œì„±' : 'âŒ ë¹„í™œì„±'}</td>
                    <td><button class="btn-ban" onclick="codeData.splice(${i},1); renderAll()">X</button></td>
                </tr>
            `).join('');

            // ìœ ì € ë Œë”ë§
            renderUserTable(userData);
        }

        function renderUserTable(users) {
            const uBody = document.getElementById('user-body');
            uBody.innerHTML = users.map((u, i) => `
                <tr style="${u.is_banned ? 'background:#fff5f5' : ''}">
                    <td><strong>${u.nickname || 'ì´ë¦„ì—†ìŒ'}</strong></td>
                    <td><input type="number" value="${u.gold}" onchange="updateUserLocal(${i}, 'gold', this.value)" style="width:100px;"></td>
                    <td><input type="number" value="${u.money || 0}" onchange="updateUserLocal(${i}, 'money', this.value)" style="width:100px;"></td>
                    <td><input type="number" value="${u.current_sword_lvl || 1}" onchange="updateUserLocal(${i}, 'current_sword_lvl', this.value)" style="width:60px;"></td>
                    <td><span style="color:${u.is_banned ? 'red':'green'}">${u.is_banned ? 'ì •ì§€' : 'ì •ìƒ'}</span></td>
                    <td>
                        <button class="btn-ban" onclick="toggleUserBan(${i})">${u.is_banned ? 'í•´ì œ' : 'ì •ì§€'}</button>
                    </td>
                </tr>
            `).join('');
        }

        function updateUserLocal(idx, field, val) { userData[idx][field] = Number(val); }

        function toggleUserBan(idx) {
            userData[idx].is_banned = !userData[idx].is_banned;
            renderAll();
        }

        async function saveAllData() {
            if(!confirm("ëª¨ë“  ë³€ê²½ì‚¬í•­(ê²€, ì½”ë“œ, ìœ ì €)ì„ ì„œë²„ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            
            try {
                // 1. ê²€ ë°ì´í„° ì €ì¥
                await _gameClient.from('sword_data').delete().neq('level', -1);
                await _gameClient.from('sword_data').insert(swordData);

                // 2. ì½”ë“œ ë°ì´í„° ì €ì¥ (upsert)
                for(let c of codeData) {
                    await _gameClient.from('reward_codes').upsert(c);
                }

                // 3. ìœ ì € ë°ì´í„° ì—…ë°ì´íŠ¸
                for(let u of userData) {
                    await _gameClient.from('profiles').update({
                        gold: u.gold,
                        money: u.money,
                        current_sword_lvl: u.current_sword_lvl,
                        is_banned: u.is_banned
                    }).eq('id', u.id);
                }

                alert("âœ… ëª¨ë“  ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                loadGameData();
            } catch(e) {
                alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
            }
        }

        function switchTab(type) {
            document.querySelectorAll('.section-card').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + type).style.display = 'block';
            event.currentTarget.classList.add('active');
        }

        function addSwordRow() { swordData.push({ level: swordData.length+1, name: 'ìƒˆ ê²€', upgrade_cost: 1000, success_rate: 0.5 }); renderAll(); }
        function addCodeRow() { codeData.push({ code: 'NEW_CODE', reward_gold: 1000, max_uses: 100, per_user_limit: 1, active: true }); renderAll(); }
        
        loadGameData();
    </script>
</body>
</html>
