<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì½”ëƒ ê²Œì„ì¦ˆ ê´€ë¦¬ - í†µí•© íŒ¨ë„</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #4dabf7; --bg: #f8f9fa; --sidebar: #1a1d21; }
        body { margin: 0; font-family: 'Pretendard', -apple-system, sans-serif; background: var(--bg); color: #333; }
        
        .top-nav { background: #1a1d21; color: white; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .back-btn { background: var(--primary); border: none; color: white; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        
        main { padding: 30px; max-width: 1200px; margin: 0 auto; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .tab-menu { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; background: #e9ecef; font-weight: bold; }
        .tab-btn.active { background: var(--primary); color: white; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-size: 13px; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
        input { padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%; box-sizing: border-box; }
        
        .save-btn { background: #27ae60; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .del-btn { background: #ff6b6b; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="top-nav">
        <button class="back-btn" onclick="location.href='index.html'"><i class="fas fa-arrow-left"></i> ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</button>
        <span style="font-weight: bold; color: var(--primary);">codetbase ê²Œì„ ê´€ë¦¬ íŒ¨ë„</span>
    </div>

    <main>
        <div class="section-header">
            <h1>ğŸ® ê²Œì„ ë°ì´í„° ì„¤ì •</h1>
            <button class="save-btn" id="save-all-btn" onclick="saveAll()">ëª¨ë“  ë°ì´í„° ì €ì¥</button>
        </div>

        <div class="tab-menu">
            <button class="tab-btn active" onclick="switchTab('sword')">âš”ï¸ ê²€ ë°ì´í„°</button>
            <button class="tab-btn" onclick="switchTab('code')">ğŸ ë³´ìƒ ì½”ë“œ</button>
            <button class="tab-btn" onclick="switchTab('user')">ğŸ‘¥ ìœ ì € ê´€ë¦¬</button>
        </div>

        <div id="tab-sword" class="card">
            <div class="section-header"><h3>ê²€ ê°•í™” íŠ¸ë¦¬</h3><button onclick="addSword()">+ ì¶”ê°€</button></div>
            <table>
                <thead><tr><th width="60">ë ˆë²¨</th><th>ì´ë¦„</th><th>ê°•í™”ë¹„ìš©</th><th>ì„±ê³µí™•ë¥ </th><th width="60">ì‚­ì œ</th></tr></thead>
                <tbody id="sword-list"></tbody>
            </table>
        </div>

        <div id="tab-code" class="card" style="display:none;">
            <div class="section-header"><h3>ì¿ í° ì½”ë“œ ê´€ë¦¬</h3><button onclick="addCode()">+ ì‹ ê·œ</button></div>
            <table>
                <thead><tr><th>ì½”ë“œ</th><th>ì§€ê¸‰ ê³¨ë“œ</th><th>ì œí•œ ìˆ˜ëŸ‰</th><th width="60">ì‚­ì œ</th></tr></thead>
                <tbody id="code-list"></tbody>
            </table>
        </div>

        <div id="tab-user" class="card" style="display:none;">
            <h3>ì‹¤ì‹œê°„ ìœ ì € ëª©ë¡ (ìµœê·¼ 50ëª…)</h3>
            <table>
                <thead><tr><th>ë‹‰ë„¤ì„</th><th>ê³¨ë“œ</th><th>ìƒíƒœ</th><th>ì‘ì—…</th></tr></thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>
    </main>

    <script>
        const GAME_URL = "https://utfrjzcnefsbuadnkdud.supabase.co";
        const GAME_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV0ZnJqemNuZWZzYnVhZG5rZHVkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MjE1MTYsImV4cCI6MjA4MjM5NzUxNn0.D3Za1nMw-x0JwOpkFuYceUHlagcpRdrpFqNUIP5Kjdc";
        const _game = supabase.createClient(GAME_URL, GAME_KEY);

        let swordData = [], codeData = [], userData = [];

        async function load() {
            const { data: s } = await _game.from('sword_data').select('*').order('level');
            const { data: c } = await _game.from('reward_codes').select('*');
            const { data: u } = await _game.from('profiles').select('*').order('updated_at', { ascending: false }).limit(50);
            
            swordData = s || []; codeData = c || []; userData = u || [];
            render();
        }

        function render() {
            // ê²€ ë°ì´í„° ë Œë”ë§
            document.getElementById('sword-list').innerHTML = swordData.map((s, i) => `
                <tr>
                    <td>${s.level}</td>
                    <td><input type="text" value="${s.name}" onchange="swordData[${i}].name=this.value"></td>
                    <td><input type="number" value="${s.upgrade_cost}" onchange="swordData[${i}].upgrade_cost=Number(this.value)"></td>
                    <td><input type="number" step="0.01" value="${s.success_rate}" onchange="swordData[${i}].success_rate=Number(this.value)"></td>
                    <td><button class="del-btn" onclick="swordData.splice(${i},1);render()">X</button></td>
                </tr>`).join('');

            // ì½”ë“œ ë°ì´í„° ë Œë”ë§
            document.getElementById('code-list').innerHTML = codeData.map((c, i) => `
                <tr>
                    <td><input type="text" value="${c.code}" onchange="codeData[${i}].code=this.value"></td>
                    <td><input type="number" value="${c.reward_gold}" onchange="codeData[${i}].reward_gold=Number(this.value)"></td>
                    <td><input type="number" value="${c.max_uses}" onchange="codeData[${i}].max_uses=Number(this.value)"></td>
                    <td><button class="del-btn" onclick="codeData.splice(${i},1);render()">X</button></td>
                </tr>`).join('');

            // ìœ ì € ë°ì´í„° ë Œë”ë§
            document.getElementById('user-list').innerHTML = userData.map((u, i) => `
                <tr>
                    <td>${u.nickname || 'ìµëª…'}</td>
                    <td><input type="number" value="${u.gold}" onchange="userData[${i}].gold=Number(this.value)"></td>
                    <td>${u.is_banned ? 'ğŸš« ì°¨ë‹¨ë¨' : 'âœ… ì •ìƒ'}</td>
                    <td><button onclick="toggleBan(${i})">${u.is_banned ? 'í•´ì œ' : 'ì°¨ë‹¨'}</button></td>
                </tr>`).join('');
        }

        function switchTab(tab) {
            document.getElementById('tab-sword').style.display = tab === 'sword' ? 'block' : 'none';
            document.getElementById('tab-code').style.display = tab === 'code' ? 'block' : 'none';
            document.getElementById('tab-user').style.display = tab === 'user' ? 'block' : 'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(tab==='sword'?'ê²€':tab==='code'?'ë³´ìƒ':'ìœ ì €')));
        }

        function addSword() { swordData.push({ level: swordData.length+1, name: 'ìƒˆ ê²€', upgrade_cost: 1000, success_rate: 0.5 }); render(); }
        function addCode() { codeData.push({ code: 'NEWCODE', reward_gold: 5000, max_uses: 100 }); render(); }
        function toggleBan(i) { userData[i].is_banned = !userData[i].is_banned; render(); }

        async function saveAll() {
            const btn = document.getElementById('save-all-btn');
            btn.innerText = "ì €ì¥ ì¤‘..."; btn.disabled = true;
            try {
                // 1. ê²€ ë°ì´í„° ì´ˆê¸°í™” í›„ ì¬ìƒì„± (ê´€ë¦¬ì ì½”ë“œ ë°©ì‹)
                await _game.from('sword_data').delete().neq('level', -1);
                await _game.from('sword_data').insert(swordData);

                // 2. ìœ ì € ë°ì´í„° ì—…ë°ì´íŠ¸
                for(let u of userData) {
                    await _game.from('profiles').update({ gold: u.gold, is_banned: u.is_banned }).eq('id', u.id);
                }
                
                alert("ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
            } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message); }
            btn.innerText = "ëª¨ë“  ë°ì´í„° ì €ì¥"; btn.disabled = false;
            load();
        }

        load();
    </script>
</body>
</html>
